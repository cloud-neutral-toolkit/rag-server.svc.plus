SHELL := /bin/bash
DENO_VERSION := $(shell deno --version 2>/dev/null | head -n1 || echo "Not Found")
MAGICK := $(shell command -v magick 2>/dev/null || command -v convert 2>/dev/null)
OS := $(shell uname -s)
PORT := 8000

.PHONY: help init info check deps dev dev-full start stop restart test build prebuild clean icon sync-dl-index css-build css-watch format lint

## Default target - show help
help:
	@echo "ğŸ‹ Fresh + Deno Dashboard - Available Commands"
	@echo ""
	@echo "Development:"
	@echo "  make dev          - Start Fresh development server"
	@echo "  make dev-full     - Start dev server + CSS watch"
	@echo "  make css-build    - Build Tailwind CSS (one-time)"
	@echo "  make css-watch    - Watch and rebuild Tailwind CSS"
	@echo ""
	@echo "Build & Deploy:"
	@echo "  make prebuild     - Generate manifests and static assets"
	@echo "  make build        - Full production build"
	@echo "  make start        - Start production server"
	@echo ""
	@echo "Testing & Quality:"
	@echo "  make check        - Type check all TypeScript files"
	@echo "  make lint         - Run Deno linter"
	@echo "  make format       - Format code with Deno fmt"
	@echo "  make test         - Run tests"
	@echo ""
	@echo "Utilities:"
	@echo "  make icon         - Generate favicon and icons"
	@echo "  make sync-dl-index - Fetch download & docs manifests"
	@echo "  make clean        - Clean build artifacts"
	@echo "  make deps         - Cache dependencies"
	@echo "  make info         - Show environment info"
	@echo ""

## Environment info
info:
	@echo "ğŸ§¾ Environment Information:"
	@echo "  Deno:        $(DENO_VERSION)"
	@echo "  OS:          $(OS)"
	@echo "  ImageMagick: $(if $(MAGICK),âœ… $(MAGICK),âŒ Not installed)"
	@echo "  Port:        $(PORT)"
	@echo ""
	@deno --version

## Check Deno installation
check-deno:
	@if ! command -v deno >/dev/null 2>&1; then \
		echo "âŒ Deno not found."; \
		if [ "$(OS)" = "Darwin" ]; then \
			echo "ğŸ‘‰ Install with: brew install deno"; \
		elif [ -f /etc/debian_version ]; then \
			echo "ğŸ‘‰ Install with: curl -fsSL https://deno.land/install.sh | sh"; \
		else \
			echo "ğŸ‘‰ Visit: https://deno.land/manual/getting_started/installation"; \
		fi; \
		exit 1; \
	fi

## Initialize project
init: check-deno
	@echo "ğŸ”§ Initializing Fresh + Deno project..."
	@echo "âœ… Deno is installed: $(DENO_VERSION)"
	@$(MAKE) deps
	@echo "âœ… Project initialized successfully!"

## Cache dependencies
deps: check-deno
	@echo "ğŸ“¦ Caching Deno dependencies..."
	@deno cache --reload main.ts dev.ts
	@deno install
	@echo "âœ… Dependencies cached!"

## Type check
check: check-deno
	@echo "ğŸ” Type checking..."
	@deno task check

## Lint code
lint: check-deno
	@echo "ğŸ” Linting code..."
	@deno task lint

## Format code
format: check-deno
	@echo "âœ¨ Formatting code..."
	@deno task fmt

## Build Tailwind CSS (one-time)
css-build: check-deno
	@echo "ğŸ¨ Building Tailwind CSS..."
	@deno task css:build
	@echo "âœ… CSS built successfully!"

## Watch and rebuild CSS
css-watch: check-deno
	@echo "ğŸ‘€ Watching Tailwind CSS..."
	@deno task css:watch

## Generate manifests and indexes
prebuild: check-deno
	@echo "ğŸ“¦ Generating manifests and static assets..."
	@$(MAKE) sync-dl-index
	@deno task prebuild
	@echo "âœ… Prebuild complete!"

## Full production build
build: check-deno
	@echo "ğŸ”¨ Building Fresh + Deno production..."
	@$(MAKE) css-build
	@$(MAKE) prebuild
	@deno task build
	@echo "âœ… Build complete!"

## Development server
dev: check-deno
	@echo "ğŸš€ Starting Fresh development server on http://localhost:$(PORT)..."
	@deno task dev

## Development server with CSS watch
dev-full: check-deno
	@echo "ğŸš€ Starting Fresh dev server + CSS watch on http://localhost:$(PORT)..."
	@deno task dev:full

## Start production server in background
start: check-deno
	@echo "ğŸš€ Starting Fresh production server in background..."
	@if [ -f dashboard.pid ]; then \
		echo "âš ï¸  Server already running (PID: $$(cat dashboard.pid))"; \
		exit 1; \
	fi
	@nohup deno task start >/tmp/dashboard-fresh.log 2>&1 & echo $$! > dashboard.pid
	@sleep 2
	@if [ -f dashboard.pid ] && kill -0 $$(cat dashboard.pid) 2>/dev/null; then \
		echo "âœ… Server started (PID: $$(cat dashboard.pid))"; \
		echo "ğŸ“‹ Logs: tail -f /tmp/dashboard-fresh.log"; \
		echo "ğŸŒ URL: http://localhost:$(PORT)"; \
	else \
		echo "âŒ Failed to start server"; \
		rm -f dashboard.pid; \
		exit 1; \
	fi

## Stop background server
stop:
	@echo "ğŸ›‘ Stopping Fresh server..."
	@if [ -f dashboard.pid ]; then \
		kill $$(cat dashboard.pid) >/dev/null 2>&1 || true; \
		rm dashboard.pid; \
		echo "âœ… Server stopped"; \
	else \
		echo "âš ï¸  No running server found"; \
	fi

## Restart server
restart: stop start

## Run tests
test: check-deno
	@echo "ğŸ§ª Running tests..."
	@deno task test || echo "âš ï¸  No tests configured"

## Generate icons
icon:
	@echo "ğŸ¨ Generating favicon and icon images..."
	@if [ -z "$(MAGICK)" ]; then \
		echo "âŒ ImageMagick not found."; \
		if [ "$(OS)" = "Darwin" ]; then \
			echo "ğŸ‘‰ Try: brew install imagemagick"; \
		elif [ -f /etc/debian_version ]; then \
			echo "ğŸ‘‰ Try: sudo apt install imagemagick"; \
		elif [ -f /etc/redhat-release ]; then \
			echo "ğŸ‘‰ Try: sudo dnf install imagemagick"; \
		fi; \
		exit 1; \
	fi
	@mkdir -p static/icons
	@if [ -f ../ui/logo.png ]; then \
		$(MAGICK) ../ui/logo.png -resize 32x32 static/icons/cloudnative_32.png; \
		$(MAGICK) ../ui/logo.png -resize 64x64 -background none -define icon:auto-resize=64,48,32,16 static/favicon.ico; \
		echo "âœ… Icons generated successfully."; \
	else \
		echo "âš ï¸  Logo file not found: ../ui/logo.png"; \
		exit 1; \
	fi

## Sync download and docs manifests
sync-dl-index:
	@echo "ğŸ“¥ Fetching download & docs manifests..."
	@mkdir -p public/dl-index
	@if curl -fsSL --connect-timeout 10 https://dl.svc.plus/manifest.json -o public/dl-index/artifacts-manifest.json; then \
		echo "âœ… Downloaded artifacts manifest"; \
	else \
		echo "âš ï¸  Unable to download artifacts manifest. Using existing snapshot."; \
	fi
	@if curl -fsSL --connect-timeout 10 https://dl.svc.plus/docs/all.json -o public/dl-index/docs-manifest.json; then \
		echo "âœ… Downloaded docs manifest"; \
	else \
		echo "âš ï¸  Unable to download docs manifest. Using existing snapshot."; \
	fi

## Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -rf _fresh
	@rm -rf static/_build
	@rm -rf node_modules
	@rm -f dashboard.pid
	@echo "âœ… Clean complete!"

## Clean everything including caches
clean-all: clean
	@echo "ğŸ§¹ Cleaning caches..."
	@deno cache --reload main.ts dev.ts
	@echo "âœ… Deep clean complete!"

## Status check
status:
	@echo "ğŸ“Š Server Status:"
	@if [ -f dashboard.pid ]; then \
		if kill -0 $$(cat dashboard.pid) 2>/dev/null; then \
			echo "  âœ… Server running (PID: $$(cat dashboard.pid))"; \
			echo "  ğŸ“‹ Logs: tail -f /tmp/dashboard-fresh.log"; \
			echo "  ğŸŒ URL: http://localhost:$(PORT)"; \
		else \
			echo "  âŒ Server PID file exists but process is not running"; \
			rm dashboard.pid; \
		fi \
	else \
		echo "  âš ï¸  No server running"; \
	fi

## Show logs
logs:
	@if [ -f /tmp/dashboard-fresh.log ]; then \
		tail -f /tmp/dashboard-fresh.log; \
	else \
		echo "âš ï¸  No log file found"; \
	fi

## Quick dev setup
quick: deps css-build
	@echo "âš¡ Quick setup complete!"
	@echo "ğŸ‘‰ Run: make dev"

## Production setup
prod: build
	@echo "ğŸš€ Production build complete!"
	@echo "ğŸ‘‰ Run: make start"
