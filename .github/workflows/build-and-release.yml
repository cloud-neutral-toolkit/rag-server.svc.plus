name: Build and Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: "Deployment target environment"
        type: choice
        options: [staging, production]
        default: staging
      allow_deploy:
        description: "Trigger deployment stage when dispatching manually"
        type: boolean
        default: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  static-security:
    name: ðŸ›¡ï¸ Static checks (lint, SAST)
    uses: ./.github/workflows/security-check.yml
    secrets: inherit

  code-quality:
    name: ðŸ§° Unit tests & code vetting
    uses: ./.github/workflows/code-analysis.yml
    secrets: inherit

  build-go-matrix:
    name: ðŸŽ§ Build Go artifacts (multi-arch)
    needs:
      - static-security
      - code-quality
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { goos: linux,   goarch: amd64 }
          - { goos: linux,   goarch: arm64 }
          - { goos: darwin,  goarch: amd64 }
          - { goos: windows, goarch: amd64 }
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.22"
      - name: Run Go tests (single representative target)
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: go test ./...
      - name: Build server and CLI
        run: |
          set -euo pipefail
          mkdir -p build
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o build/xcontrol-server-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd/xcontrol-server
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o build/xcontrol-cli-${{ matrix.goos }}-${{ matrix.goarch }} ./client
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xcontrol-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            build/xcontrol-server-${{ matrix.goos }}-${{ matrix.goarch }}
            build/xcontrol-cli-${{ matrix.goos }}-${{ matrix.goarch }}

  base-images:
    name: ðŸ›¢ï¸ Build base images (multi-arch)
    needs: build-go-matrix
    uses: ./.github/workflows/build-base-images.yml
    with:
      push_images: ${{ github.event_name != 'pull_request' }}
    secrets: inherit

  service-images:
    name: ðŸ›¢ï¸ Build service images (multi-arch + SBOM)
    needs:
      - build-go-matrix
      - base-images
    uses: ./.github/workflows/build-service-images.yml
    with:
      push_images: ${{ github.event_name != 'pull_request' }}
    secrets: inherit

  deploy-and-rollback:
    name: ðŸš€ Deploy & rollback hooks
    needs:
      - base-images
      - service-images
    if: (github.event_name == 'workflow_dispatch' && inputs.allow_deploy == true) || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare rollout context
        id: context
        run: |
          set -euo pipefail
          env_name="${{ github.event.inputs.deploy_environment || 'staging' }}"
          echo "environment=${env_name}" >> "$GITHUB_OUTPUT"
      - name: Deploy (placeholder)
        env:
          TARGET_ENV: ${{ steps.context.outputs.environment }}
        run: |
          echo "Deploying images to ${TARGET_ENV} via existing GitOps/Ansible pipelines"
          echo "Add environment-specific rollout commands here"
      - name: Rollback plan ready
        run: |
          echo "Rollback can be triggered by re-running this workflow with allow_deploy=true"
          echo "and by pointing deploy_environment to the target to restore"
