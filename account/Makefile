# =========================================
# ğŸ“¦ XControl Account Service Makefile
# =========================================

APP_NAME    := xcontrol-account
MAIN_FILE   := ./cmd/accountsvc/main.go
PORT        ?= 8080
OS          := $(shell uname -s)

DB_NAME     := account
DB_USER     := shenlan
DB_PASS     := password
DB_HOST     := 127.0.0.1
DB_PORT     := 5432
DB_URL      := postgres://$(DB_USER):$(DB_PASS)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=disable

REPLICATION_MODE ?= pgsync

DB_ADMIN_USER ?= $(DB_USER)
DB_ADMIN_PASS ?= $(DB_PASS)

SCHEMA_FILE := ./sql/schema.sql
PGLOGICAL_INIT_FILE := ./sql/schema_pglogical_init.sql
PGLOGICAL_PATCH_FILE := ./sql/schema_pglogical_patch.sql
PGLOGICAL_REGION_FILE := ./sql/schema_pglogical_region.sql

ACCOUNT_EXPORT_FILE ?= account-export.yaml
ACCOUNT_IMPORT_FILE ?= account-export.yaml
ACCOUNT_EMAIL_KEYWORD ?=
ACCOUNT_SYNC_CONFIG ?= config/sync.yaml
SUPERADMIN_USERNAME ?= Admin
SUPERADMIN_PASSWORD ?= ChangeMe
SUPERADMIN_EMAIL    ?= admin@svc.plus

export PATH := /usr/local/go/bin:$(PATH)

# =========================================
# ğŸ§© åŸºç¡€å‘½ä»¤
# =========================================

.PHONY: all init build clean start stop restart dev test help \
	init-db-core init-db-replication init-db-pglogical \
	reinit-pglogical account-sync-push account-sync-pull account-sync-mirror create-db-user db-reset

all: build

help:
	@echo "ğŸ§­ XControl Account Service Makefile"
	@echo "make init               åˆå§‹åŒ– Go ç¯å¢ƒä¸æ•°æ®åº“"
	@echo "make init-db            æ‰§è¡Œæ•°æ®åº“ schemaï¼ˆæ”¯æŒ REPLICATION_MODE=pgsync|pglogicalï¼‰"
	@echo "make create-db-user     åˆ›å»ºæ•°æ®åº“ç”¨æˆ·å¹¶æˆæƒ"
	@echo "make db-reset           é‡ç½®æ•´ä¸ª PostgreSQL é›†ç¾¤ (å±é™©æ“ä½œ!)"
	@echo "make migrate-db         æ‰§è¡Œæ•°æ®åº“è¿ç§»"
	@echo "make dump-schema        å¯¼å‡ºæ•°æ®åº“ schema"
	@echo "make account-export     å¯¼å‡ºè´¦å·æ•°æ®ä¸º YAML"
	@echo "make account-import     ä» YAML å¯¼å…¥è´¦å·æ•°æ®"
	@echo "make create-super-admin åˆ›å»ºè¶…çº§ç®¡ç†å‘˜"
	@echo "make reinit-db          é‡ç½®ä¸šåŠ¡ schema (ä¸æ¶‰åŠ pglogical)"
	@echo "make reinit-pglogical   é‡æ–°åˆå§‹åŒ– pglogical schema"
	@echo "make dev                çƒ­é‡è½½å¼€å‘æ¨¡å¼"
	@echo "make clean              æ¸…ç†æ„å»ºäº§ç‰©"

# =========================================
# ğŸ§° åˆå§‹åŒ–
# =========================================

init: init-go init-db

init-go:
	@echo ">>> æ£€æŸ¥ Go ç¯å¢ƒ"
	@if ! command -v go >/dev/null; then \
		echo "æœªå®‰è£… Goï¼Œè‡ªåŠ¨å®‰è£…ä¸­..."; \
		([ "$(OS)" = "Darwin" ] && brew install go@1.24 && brew link --overwrite --force go@1.24) || \
		(sudo apt-get update && sudo apt-get install -y golang); \
	fi
	@echo ">>> é…ç½® Go Proxy"
	@(curl -fsSL --max-time 5 https://goproxy.cn >/dev/null && go env -w GOPROXY=https://goproxy.cn,direct) || \
	(go env -w GOPROXY=https://proxy.golang.org,direct)
	@go mod tidy

init-db:
	@echo ">>> åˆå§‹åŒ–æ•°æ®åº“ schema"
	@command -v psql >/dev/null || (echo "âŒ æœªæ£€æµ‹åˆ° psqlï¼Œè¯·å®‰è£… PostgreSQL å®¢æˆ·ç«¯" && exit 1)
	@$(MAKE) init-db-core
	@$(MAKE) init-db-replication

init-db-core:
	@echo ">>> åˆå§‹åŒ–ä¸šåŠ¡ schema ($(SCHEMA_FILE))"
	@psql "$(DB_URL)" -v ON_ERROR_STOP=1 -f $(SCHEMA_FILE)

init-db-replication:
	@if [ "$(REPLICATION_MODE)" = "pglogical" ]; then \
		$(MAKE) init-db-pglogical; \
	else \
		echo ">>> è·³è¿‡ pglogical åˆå§‹åŒ– (REPLICATION_MODE=$(REPLICATION_MODE))"; \
	fi

init-db-pglogical:
	@if [ -f $(PGLOGICAL_INIT_FILE) ]; then \
		echo ">>> åˆå§‹åŒ– pglogical schema (REPLICATION_MODE=pglogical)"; \
		if PGPASSWORD="$(DB_ADMIN_PASS)" psql -h $(DB_HOST) -U $(DB_ADMIN_USER) -d $(DB_NAME) \
			-Atc "SELECT rolsuper FROM pg_roles WHERE rolname = current_user" 2>/dev/null | grep -qx 't'; then \
			PGPASSWORD="$(DB_ADMIN_PASS)" psql -h $(DB_HOST) -U $(DB_ADMIN_USER) -d $(DB_NAME) \
				-v ON_ERROR_STOP=1 -f $(PGLOGICAL_INIT_FILE); \
		elif psql "$(DB_URL)" -Atc "SELECT rolsuper FROM pg_roles WHERE rolname = current_user" | grep -qx 't'; then \
			psql "$(DB_URL)" -v ON_ERROR_STOP=1 -f $(PGLOGICAL_INIT_FILE); \
		else \
			echo "âš ï¸ å½“å‰ç”¨æˆ·éè¶…çº§ç”¨æˆ·ï¼Œè·³è¿‡ pglogical åˆå§‹åŒ–"; \
		fi; \
	fi; \
	if [ -f $(PGLOGICAL_PATCH_FILE) ]; then \
		echo ">>> åº”ç”¨ pglogical é»˜è®¤å€¼è¡¥ä¸"; \
		psql "$(DB_URL)" -v ON_ERROR_STOP=1 -f $(PGLOGICAL_PATCH_FILE); \
	fi

# =========================================
# ğŸ§  PGLogical åŒèŠ‚ç‚¹åˆå§‹åŒ–
# =========================================

init-pglogical-region:
	@[ -n "$(REGION_DB_URL)" ] || (echo "âŒ ç¼ºå°‘ REGION_DB_URL"; exit 1)
	@[ -n "$(NODE_NAME)" ] || (echo "âŒ ç¼ºå°‘ NODE_NAME"; exit 1)
	@[ -n "$(NODE_DSN)" ] || (echo "âŒ ç¼ºå°‘ NODE_DSN"; exit 1)
	@[ -n "$(SUBSCRIPTION_NAME)" ] || (echo "âŒ ç¼ºå°‘ SUBSCRIPTION_NAME"; exit 1)
	@[ -n "$(PROVIDER_DSN)" ] || (echo "âŒ ç¼ºå°‘ PROVIDER_DSN"; exit 1)
	@psql "$(REGION_DB_URL)" -v ON_ERROR_STOP=1 \
		-v NODE_NAME="$(NODE_NAME)" \
		-v NODE_DSN="$(NODE_DSN)" \
		-v SUBSCRIPTION_NAME="$(SUBSCRIPTION_NAME)" \
		-v PROVIDER_DSN="$(PROVIDER_DSN)" \
		-f $(PGLOGICAL_REGION_FILE)

init-pglogical-region-cn:
	@$(MAKE) init-pglogical-region \
		REGION_DB_URL="$(DB_URL)" \
		NODE_NAME="node_cn" \
		NODE_DSN="host=cn-homepage.svc.plus port=5432 dbname=account user=pglogical password=xxxx" \
		SUBSCRIPTION_NAME="sub_from_global" \
		PROVIDER_DSN="host=global-homepage.svc.plus port=5432 dbname=account user=pglogical password=xxxx"

init-pglogical-region-global:
	@$(MAKE) init-pglogical-region \
		REGION_DB_URL="$(DB_URL)" \
		NODE_NAME="node_global" \
		NODE_DSN="host=global-homepage.svc.plus port=5432 dbname=account user=pglogical password=xxxx" \
		SUBSCRIPTION_NAME="sub_from_cn" \
		PROVIDER_DSN="host=cn-homepage.svc.plus port=5432 dbname=account user=pglogical password=xxxx"

# =========================================
# ğŸ“¦ æ•°æ®åº“è¿ç§»ä¸ç®¡ç†
# =========================================

create-db-user:
	@echo ">>> åˆ›å»ºæ•°æ®åº“ç”¨æˆ· $(DB_USER)"
	@command -v psql >/dev/null || (echo "âŒ æœªæ£€æµ‹åˆ° psqlï¼Œè¯·å®‰è£… PostgreSQL å®¢æˆ·ç«¯" && exit 1)
	@echo "æ­£åœ¨ä»¥ postgres è¶…çº§ç”¨æˆ·èº«ä»½åˆ›å»ºç”¨æˆ·..."
	@sudo -u postgres psql -c "CREATE USER $(DB_USER) WITH PASSWORD '$(DB_PASS)';" || echo "âš ï¸ ç”¨æˆ·å¯èƒ½å·²å­˜åœ¨"
	@sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $(DB_NAME) TO $(DB_USER);"
	@echo "âœ“ æ•°æ®åº“ç”¨æˆ·åˆ›å»ºå®Œæˆ"

migrate-db:
	@echo ">>> æ‰§è¡Œæ•°æ®åº“è¿ç§»"
	@go run ./cmd/migratectl/main.go migrate --dsn "$(DB_URL)" --dir sql/migrations

dump-schema:
	@echo ">>> å¯¼å‡º schema åˆ° $(SCHEMA_FILE)"
	@pg_dump -s -O -x "$(DB_URL)" > $(SCHEMA_FILE)

db-reset:
	@echo "âš ï¸ å³å°†é‡ç½®æ•´ä¸ª PostgreSQL æ•°æ®åº“é›†ç¾¤ ..."
	@read -p "ç¡®å®šè¦é‡ç½®æ•°æ®åº“é›†ç¾¤? è¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®! [y/N] " confirm && \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		echo ">>> åœæ­¢ PostgreSQL æœåŠ¡ ..."; \
		sudo systemctl stop postgresql; \
		echo ">>> åˆ é™¤æ•°æ®åº“é›†ç¾¤ 16 main ..."; \
		sudo pg_dropcluster --stop 16 main; \
		echo ">>> æ¸…ç†æ•°æ®ç›®å½• ..."; \
		sudo rm -rf /var/lib/postgresql/16/main; \
		echo ">>> æ¸…ç†é…ç½®ç›®å½• ..."; \
		sudo rm -rf /etc/postgresql/16/main; \
		echo ">>> åˆ›å»ºæ–°çš„æ•°æ®åº“é›†ç¾¤ ..."; \
		sudo pg_createcluster 16 main --start; \
		echo "âœ“ PostgreSQL é›†ç¾¤é‡ç½®å®Œæˆ"; \
	else \
		echo "å–æ¶ˆé‡ç½®"; \
	fi

drop-db:
	@echo "âš ï¸  å³å°†åˆ é™¤æ•°æ®åº“ $(DB_NAME) ..."
	@read -p "ç¡®å®šè¦åˆ é™¤æ•°æ®åº“ $(DB_NAME)? [y/N] " confirm && \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		echo ">>> å¼ºåˆ¶æ–­å¼€ç°æœ‰è¿æ¥ ..."; \
		if ! PGPASSWORD="$(DB_ADMIN_PASS)" psql -h $(DB_HOST) -U $(DB_ADMIN_USER) -d postgres \
			-c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname='$(DB_NAME)' AND pid <> pg_backend_pid();"; then \
			echo "âš ï¸ æ— æ³•æ–­å¼€æ‰€æœ‰è¿æ¥ï¼ˆéœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼‰"; \
		fi; \
		echo ">>> æ¸…ç† pglogical schema ..."; \
		PGPASSWORD="$(DB_ADMIN_PASS)" psql -h $(DB_HOST) -U $(DB_ADMIN_USER) -d $(DB_NAME) \
			-c "DROP SCHEMA IF EXISTS pglogical CASCADE;" >/dev/null 2>&1 || \
			echo "âš ï¸ æ— æ³•åˆ é™¤ pglogical schemaï¼ˆæ•°æ®åº“å¯èƒ½ä¸å­˜åœ¨æˆ–ç¼ºå°‘æƒé™ï¼‰"; \
		echo ">>> åˆ é™¤æ•°æ®åº“ $(DB_NAME) ..."; \
		if PGPASSWORD="$(DB_ADMIN_PASS)" psql -h $(DB_HOST) -U $(DB_ADMIN_USER) -d postgres \
			-c "DROP DATABASE IF EXISTS $(DB_NAME);"; then \
			echo ">>> æ•°æ®åº“å·²åˆ é™¤"; \
		else \
			echo ">>> åˆ é™¤å¤±è´¥"; \
		fi; \
	else \
		echo "å–æ¶ˆåˆ é™¤"; \
	fi

reset-public-schema:
	@psql "$(DB_URL)" -v ON_ERROR_STOP=1 -v db_user="$(DB_USER)" -f sql/reset_public_schema.sql

reinit-db:
	@echo ">>> é‡ç½®ä¸šåŠ¡ schema (sql/schema.sql)"
	@$(MAKE) reset-public-schema
	@$(MAKE) init-db-core

reinit-pglogical:
	@if [ "$(REPLICATION_MODE)" = "pglogical" ]; then \
		echo ">>> é‡æ–°åˆå§‹åŒ– pglogical schema"; \
		$(MAKE) init-db-pglogical; \
	else \
		echo ">>> å½“å‰ REPLICATION_MODE=$(REPLICATION_MODE)ï¼Œæ— éœ€ pglogical å¤„ç†"; \
	fi

# =========================================
# ğŸ’¾ è´¦å·å¯¼å…¥å¯¼å‡º
# =========================================

account-export:
	@go run ./cmd/migratectl/main.go export --dsn "$(DB_URL)" --output "$(ACCOUNT_EXPORT_FILE)" $(if $(ACCOUNT_EMAIL_KEYWORD),--email "$(ACCOUNT_EMAIL_KEYWORD)")

account-import:
	@[ -f "$(ACCOUNT_IMPORT_FILE)" ] || (echo "âŒ æœªæ‰¾åˆ°æ–‡ä»¶ $(ACCOUNT_IMPORT_FILE)"; exit 1)
	@go run ./cmd/migratectl/main.go import --dsn "$(DB_URL)" --file "$(ACCOUNT_IMPORT_FILE)" \
	        $(if $(ACCOUNT_IMPORT_MERGE),--merge) \
	        $(if $(ACCOUNT_IMPORT_MERGE_STRATEGY),--merge-strategy "$(ACCOUNT_IMPORT_MERGE_STRATEGY)") \
	        $(if $(ACCOUNT_IMPORT_DRY_RUN),--dry-run) \
	        $(foreach UUID,$(ACCOUNT_IMPORT_MERGE_ALLOWLIST),--merge-allowlist $(UUID)) \
	        $(ACCOUNT_IMPORT_EXTRA_FLAGS)

account-sync-push:
	@[ -f "$(ACCOUNT_SYNC_CONFIG)" ] || (echo "âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $(ACCOUNT_SYNC_CONFIG)"; exit 1)
	@go run ./cmd/syncctl/main.go push --config "$(ACCOUNT_SYNC_CONFIG)"

account-sync-pull:
	@[ -f "$(ACCOUNT_SYNC_CONFIG)" ] || (echo "âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $(ACCOUNT_SYNC_CONFIG)"; exit 1)
	@go run ./cmd/syncctl/main.go pull --config "$(ACCOUNT_SYNC_CONFIG)"

account-sync-mirror:
	@[ -f "$(ACCOUNT_SYNC_CONFIG)" ] || (echo "âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $(ACCOUNT_SYNC_CONFIG)"; exit 1)
	@go run ./cmd/syncctl/main.go mirror --config "$(ACCOUNT_SYNC_CONFIG)"

create-super-admin:
	@[ -n "$(SUPERADMIN_USERNAME)" ] && [ -n "$(SUPERADMIN_PASSWORD)" ] || (echo "âŒ è¯·æŒ‡å®šç”¨æˆ·åä¸å¯†ç "; exit 1)
	@go run ./cmd/createadmin/main.go \
		--driver postgres \
		--dsn "$(DB_URL)" \
		--username "$(SUPERADMIN_USERNAME)" \
		--password "$(SUPERADMIN_PASSWORD)" \
		--email "$(SUPERADMIN_EMAIL)"

# =========================================
# âš™ï¸ ç¼–è¯‘ä¸è¿è¡Œ
# =========================================

build:
	@go build -o $(APP_NAME) $(MAIN_FILE)

upgrade: build
	systemctl stop xcontrol-account
	cp xcontrol-account /usr/bin/xcontrol-account
	systemctl start xcontrol-account

start: build
	@./$(APP_NAME) --config config/account.yaml

stop:
	@pkill -f "$(APP_NAME)" || echo "âš ï¸ æœªæ‰¾åˆ°è¿è¡Œè¿›ç¨‹"

restart: stop start

test:
	go test ./...

clean:
	rm -f $(APP_NAME) *.pid *.log
