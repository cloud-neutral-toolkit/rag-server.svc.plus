OS := $(shell uname -s)
PORT := 8090
MODULE := xcontrol
APP_NAME := xcontrol-server
MAIN_FILE := cmd/xcontrol-server/main.go

DB_NAME := knowledge_db
DB_USER := shenlan
DB_HOST := 127.0.0.1
DB_PORT := 5432
DB_URL  := postgres://$(DB_USER):password@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=disable
SCHEMA_FILE := sql/schema.sql

PSQL := psql "$(DB_URL)" -v ON_ERROR_STOP=1
export PATH := /usr/local/go/bin:$(PATH)

.PHONY: all build start stop restart clean init help dev test init-db reinit-db drop-db

all: build

init:
	go mod init rag-server || true
	go mod tidy
	@echo ">>> åˆå§‹åŒ– Go ä¾èµ–ç¯å¢ƒ"
	@if command -v go >/dev/null 2>&1; then \
	echo "Go å·²å®‰è£…"; \
	else \
	echo "å®‰è£… Go"; \
	if [ "$(OS)" = "Darwin" ]; then \
	brew install go@1.24 && brew link --overwrite --force go@1.24; \
	else \
	sudo apt-get update && sudo apt-get install -y golang; \
	fi; \
	fi
	@if curl -s --max-time 5 https://goproxy.cn >/dev/null; then \
	echo "ä½¿ç”¨å›½å†…é•œåƒ: goproxy.cn"; \
	go env -w GOPROXY=https://goproxy.cn,direct; \
	else \
	echo "å›½å†…é•œåƒä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤: proxy.golang.org"; \
	go env -w GOPROXY=https://proxy.golang.org,direct; \
	fi
	@echo ">>> æ‰§è¡Œ go mod tidy"
	go mod tidy
	@echo ">>> å¯é€‰å®‰è£… air (å¼€å‘çƒ­é‡è½½)"
	@echo "å¦‚éœ€å®‰è£…ï¼Œè¯·è¿è¡Œ: go install github.com/air-verse/air@latest"

build: init
	@echo ">>> ç¼–è¯‘ $(APP_NAME)"
	go build -o $(APP_NAME) $(MAIN_FILE)

start:
	@echo ">>> è¿è¡Œ $(APP_NAME) on port $(PORT) (åå°è¿è¡Œ)"
	@nohup env PORT=$(PORT) go run $(MAIN_FILE) > $(APP_NAME).log 2>&1 & echo $$! > $(APP_NAME).pid

stop:
	@echo ">>> åœæ­¢ $(APP_NAME)"
	@if [ -f $(APP_NAME).pid ]; then \
	        kill `cat $(APP_NAME).pid` >/dev/null 2>&1 || true; \
	        rm $(APP_NAME).pid; \
	else \
	        echo "æœªæ‰¾åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹"; \
	fi

restart: stop start

test:
	@echo ">>> è¿è¡Œå•å…ƒæµ‹è¯•"
	go test ./...

dev:
	@echo ">>> å¼€å‘æ¨¡å¼è¿è¡Œ $(APP_NAME) (çƒ­é‡è½½) on port $(PORT)"
	@if command -v air >/dev/null; then \
		PORT=$(PORT) air -c .air.toml; \
	else \
		echo "æœªæ£€æµ‹åˆ° airï¼Œç›´æ¥è¿è¡Œ go run"; \
		PORT=$(PORT) go run $(MAIN_FILE); \
	fi

clean:
	@echo ">>> æ¸…ç†æ„å»ºäº§ç‰©"
	rm -f $(APP_NAME)

create-db:
	@echo ">>> åˆ›å»ºæ•°æ®åº“ $(DB_NAME)"
	@sudo -u postgres createdb $(DB_NAME) || echo "æ•°æ®åº“å·²å­˜åœ¨ï¼Œè·³è¿‡"
	@sudo -u postgres psql -d $(DB_NAME) -c "CREATE EXTENSION IF NOT EXISTS vector;"
	@sudo -u postgres psql -d $(DB_NAME) -c "CREATE EXTENSION IF NOT EXISTS zhparser;"
	@sudo -u postgres psql -d $(DB_NAME) -c "\dx"

init-db:
	@echo ">>> åˆå§‹åŒ– RAG schema ($(SCHEMA_FILE))"
	# ğŸ§© ç¡®ä¿ public schema å½’å±æ­£ç¡®ï¼ˆé˜²æ­¢ zhparser æ— æ³•åˆ›å»º TEXT SEARCH CONFIGï¼‰
	@echo ">>> æ£€æŸ¥å¹¶æˆæƒ public schema æ‰€æœ‰æƒä¸ CREATE æƒé™"
	@sudo -u postgres psql -d $(DB_NAME) -c "ALTER SCHEMA public OWNER TO $(DB_USER);" || true
	@sudo -u postgres psql -d $(DB_NAME) -c "GRANT CREATE ON SCHEMA public TO $(DB_USER);" || true
	@echo ">>> åˆå§‹åŒ– RAG schema ($(SCHEMA_FILE))"
	@$(PSQL) -f $(SCHEMA_FILE)

drop-db:
	@echo ">>> åˆ é™¤ RAG schema å¯¹è±¡"
	@$(PSQL) -c "DROP TABLE IF EXISTS public.documents CASCADE;"

reinit-db: drop-db init-db

help:
	@echo " XControl Server Makefile"
	@echo ""
	@echo "make build     ç¼–è¯‘ server å¯æ‰§è¡Œæ–‡ä»¶"
	@echo "make start     åå°è¿è¡Œ server (é»˜è®¤ç«¯å£: $(PORT))"
	@echo "make stop      åœæ­¢è¿è¡Œ server"
	@echo "make restart   é‡å¯ server"
	@echo "make test      è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "make dev       å¼€å‘æ¨¡å¼è¿è¡Œ (è‡ªåŠ¨æ£€æµ‹ airï¼Œå¦‚æ— åˆ™ç”¨ go run)"
	@echo "make init      åˆå§‹åŒ–ä¾èµ–ï¼ˆè‡ªåŠ¨é€‰æ‹©å›½å†…/é»˜è®¤ Go æ¨¡å—ä»£ç†ï¼Œair å¯é€‰ï¼‰"
	@echo "make clean     æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "make init-db   åˆå§‹åŒ–æ•°æ®åº“ schema ($(SCHEMA_FILE))"
	@echo "make drop-db   åˆ é™¤ RAG ç›¸å…³æ•°æ®åº“å¯¹è±¡"
	@echo "make reinit-db é‡ç½®æ•°æ®åº“ schema (drop + init)"
